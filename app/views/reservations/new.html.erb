<div class="min-h-screen bg-gray-100 py-8 px-4 sm:px-6 lg:px-8 flex items-center justify-center" 
     data-controller="step-form" 
     data-step-form-total-steps-value="9">
  <!-- 휴대폰 모양 컨테이너 -->
  <div class="w-full max-w-sm mx-auto">
    <!-- 스마트폰 프레임 -->
    <div class="bg-black p-2 rounded-[2.5rem] w-full max-w-[375px] mx-auto shadow-2xl">
      <!-- 노치 -->
      <div class="bg-black h-6 flex items-center justify-center rounded-t-[2rem]">
        <div class="w-32 h-5 bg-black rounded-b-[1.5rem]"></div>
      </div>
      
      <!-- 화면 영역 -->
      <div class="bg-white overflow-hidden min-h-[600px] rounded-[2rem]">
        <!-- 진행률 표시 -->
        <div class="px-6 pt-6 pb-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-base font-semibold text-gray-900" data-step-form-target="stepNumber">1 / 9 단계</span>
            <span class="text-base font-semibold text-gray-900" data-step-form-target="progressPercent">11%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3 shadow-inner">
            <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 h-3 rounded-full transition-all duration-500 shadow-sm" 
                 data-step-form-target="progressBar" 
                 style="width: 11%"></div>
          </div>
        </div>

        <!-- 예약 폼 -->
        <div class="px-6 pb-6">
      <%= turbo_frame_tag "reservation_form" do %>
        <%= form_with model: @reservation, 
                      class: "space-y-6",
                      id: "reservation-form" do |f| %>
          
          <!-- 1단계: 이름 -->
          <div data-step-form-target="step" class="step-content">
            <div>
              <%= f.label :name, "이름", class: "block text-base font-semibold text-gray-900 mb-3" %>
              <%= f.text_field :name, 
                              required: true,
                              class: "w-full px-5 py-4 text-base border-2 border-gray-200 rounded-2xl focus:ring-0 focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-500/20 transition-all duration-200 bg-white placeholder:text-gray-400",
                              placeholder: "예: 홍길동" %>
              <% if @reservation.errors[:name].any? %>
                <p class="mt-2 text-sm text-red-500"><%= @reservation.errors[:name].first %></p>
              <% end %>
            </div>
            <div class="mt-8">
              <button type="button" 
                      data-action="click->step-form#next"
                      class="w-full bg-gray-800 text-white py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-900 active:scale-[0.98] transition-all duration-200 shadow-lg shadow-gray-900/20">
                다음
              </button>
            </div>
          </div>
          
          <!-- 2단계: 연락처 -->
          <div data-step-form-target="step" class="step-content hidden">
            <div>
              <%= f.label :phone, "연락처", class: "block text-base font-semibold text-gray-900 mb-3" %>
              <%= f.telephone_field :phone, 
                                   required: true,
                                   class: "w-full px-5 py-4 text-base border-2 border-gray-200 rounded-2xl focus:ring-0 focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-500/20 transition-all duration-200 bg-white placeholder:text-gray-400",
                                   placeholder: "예: 01012345678" %>
              <% if @reservation.errors[:phone].any? %>
                <p class="mt-2 text-sm text-red-500"><%= @reservation.errors[:phone].first %></p>
              <% end %>
            </div>
            <div class="mt-8 flex gap-3">
              <button type="button" 
                      data-action="click->step-form#previous"
                      class="flex-1 bg-gray-100 text-gray-700 py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-200 active:scale-[0.98] transition-all duration-200">
                이전
              </button>
              <button type="button" 
                      data-action="click->step-form#next"
                      class="flex-1 bg-gray-800 text-white py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-900 active:scale-[0.98] transition-all duration-200 shadow-lg shadow-gray-900/20">
                다음
              </button>
            </div>
          </div>
          
          <!-- 3단계: 이메일 -->
          <div data-step-form-target="step" class="step-content hidden">
            <div>
              <%= f.label :email, "이메일", class: "block text-base font-semibold text-gray-900 mb-3" %>
              <%= f.email_field :email, 
                              required: true,
                              class: "w-full px-5 py-4 text-base border-2 border-gray-200 rounded-2xl focus:ring-0 focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-500/20 transition-all duration-200 bg-white placeholder:text-gray-400",
                              placeholder: "예: example@email.com" %>
              <% if @reservation.errors[:email].any? %>
                <p class="mt-2 text-sm text-red-500"><%= @reservation.errors[:email].first %></p>
              <% end %>
            </div>
            <div class="mt-8 flex gap-3">
              <button type="button" 
                      data-action="click->step-form#previous"
                      class="flex-1 bg-gray-100 text-gray-700 py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-200 active:scale-[0.98] transition-all duration-200">
                이전
              </button>
              <button type="button" 
                      data-action="click->step-form#next"
                      class="flex-1 bg-gray-800 text-white py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-900 active:scale-[0.98] transition-all duration-200 shadow-lg shadow-gray-900/20">
                다음
              </button>
            </div>
          </div>
          
          <!-- 4단계: 예약 날짜/시간 -->
          <div data-step-form-target="step" class="step-content hidden">
            <div>
              <%= f.label :reservation_datetime, "예약 날짜 및 시간", class: "block text-base font-semibold text-gray-900 mb-3" %>
              <%= f.datetime_local_field :reservation_datetime, 
                                        required: true,
                                        class: "w-full px-5 py-4 text-base border-2 border-gray-200 rounded-2xl focus:ring-0 focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-500/20 transition-all duration-200 bg-white" %>
              <% if @reservation.errors[:reservation_datetime].any? %>
                <p class="mt-2 text-sm text-red-500"><%= @reservation.errors[:reservation_datetime].first %></p>
              <% end %>
            </div>
            <div class="mt-8 flex gap-3">
              <button type="button" 
                      data-action="click->step-form#previous"
                      class="flex-1 bg-gray-100 text-gray-700 py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-200 active:scale-[0.98] transition-all duration-200">
                이전
              </button>
              <button type="button" 
                      data-action="click->step-form#next"
                      class="flex-1 bg-gray-800 text-white py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-900 active:scale-[0.98] transition-all duration-200 shadow-lg shadow-gray-900/20">
                다음
              </button>
            </div>
          </div>
          
          <!-- 5단계: 코칭 형태 -->
          <div data-step-form-target="step" class="step-content hidden">
            <div>
              <%= f.label :coaching_type, "코칭 형태", class: "block text-base font-semibold text-gray-900 mb-3" %>
              <%= f.select :coaching_type, 
                          options_for_select(Reservation::COACHING_TYPES.map { |type| [type, type] }, @reservation.coaching_type),
                          { prompt: "코칭 형태를 선택해주세요" },
                          { required: true,
                            class: "w-full px-5 py-4 text-base border-2 border-gray-200 rounded-2xl focus:ring-0 focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-500/20 transition-all duration-200 bg-white" } %>
              <% if @reservation.errors[:coaching_type].any? %>
                <p class="mt-2 text-sm text-red-500"><%= @reservation.errors[:coaching_type].first %></p>
              <% end %>
            </div>
            <div class="mt-8 flex gap-3">
              <button type="button" 
                      data-action="click->step-form#previous"
                      class="flex-1 bg-gray-100 text-gray-700 py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-200 active:scale-[0.98] transition-all duration-200">
                이전
              </button>
              <button type="button" 
                      data-action="click->step-form#next"
                      class="flex-1 bg-gray-800 text-white py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-900 active:scale-[0.98] transition-all duration-200 shadow-lg shadow-gray-900/20">
                다음
              </button>
            </div>
          </div>
          
          <!-- 6단계: 선택 과목 -->
          <div data-step-form-target="step" class="step-content hidden">
            <div>
              <%= f.label :selected_subjects, "선택 과목 (복수 선택 가능)", class: "block text-base font-semibold text-gray-900 mb-3" %>
              <div class="space-y-2 mt-2">
                <% Reservation::SUBJECT_OPTIONS.each do |subject| %>
                  <label class="flex items-center space-x-3 cursor-pointer p-4 border-2 border-gray-200 rounded-2xl hover:bg-indigo-50 hover:border-indigo-300 hover:shadow-md transition-all">
                    <%= check_box_tag "reservation[selected_subjects][]", 
                                     subject, 
                                     @reservation.selected_subjects&.include?(subject),
                                     class: "w-6 h-6 text-indigo-600 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" %>
                    <span class="text-base text-gray-900"><%= subject %></span>
                  </label>
                <% end %>
              </div>
            </div>
            <div class="mt-8 flex gap-3">
              <button type="button" 
                      data-action="click->step-form#previous"
                      class="flex-1 bg-gray-100 text-gray-700 py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-200 active:scale-[0.98] transition-all duration-200">
                이전
              </button>
              <button type="button" 
                      data-action="click->step-form#next"
                      class="flex-1 bg-gray-800 text-white py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-900 active:scale-[0.98] transition-all duration-200 shadow-lg shadow-gray-900/20">
                다음
              </button>
            </div>
          </div>
          
          <!-- 7단계: 요청사항 -->
          <div data-step-form-target="step" class="step-content hidden">
            <div>
              <%= f.label :requests, "요청사항 (선택사항)", class: "block text-base font-semibold text-gray-900 mb-3" %>
              <%= f.text_area :requests, 
                             rows: 4,
                             class: "w-full px-5 py-4 text-base border-2 border-gray-200 rounded-2xl focus:ring-0 focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-500/20 transition-all duration-200 bg-white",
                             placeholder: "추가로 요청하실 사항이 있으시면 작성해주세요" %>
            </div>
            <div class="mt-8 flex gap-3">
              <button type="button" 
                      data-action="click->step-form#previous"
                      class="flex-1 bg-gray-100 text-gray-700 py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-200 active:scale-[0.98] transition-all duration-200">
                이전
              </button>
              <button type="button" 
                      data-action="click->step-form#next"
                      class="flex-1 bg-gray-800 text-white py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-900 active:scale-[0.98] transition-all duration-200 shadow-lg shadow-gray-900/20">
                다음
              </button>
            </div>
          </div>
          
          <!-- 8단계: 개인정보 동의 -->
          <div data-step-form-target="step" class="step-content hidden">
            <div>
              <%= f.label :privacy_agreed, "개인정보 수집 및 이용 동의", class: "block text-base font-semibold text-gray-900 mb-4" %>
              <div class="flex items-start space-x-3 p-4 border-2 border-gray-200 rounded-2xl hover:bg-indigo-50 hover:border-indigo-300 hover:shadow-md transition-all">
                <%= f.check_box :privacy_agreed, 
                              { class: "mt-1 w-6 h-6 text-indigo-600 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" } %>
                <label for="reservation_privacy_agreed" class="text-base text-gray-900 flex-1">
                  개인정보 수집 및 이용에 동의합니다.
                  <a href="#" class="text-indigo-600 hover:text-indigo-800 underline">자세히 보기</a>
                </label>
              </div>
              <% if @reservation.errors[:privacy_agreed].any? %>
                <p class="mt-2 text-sm text-red-500"><%= @reservation.errors[:privacy_agreed].first %></p>
              <% end %>
            </div>
            <div class="mt-8 flex gap-3">
              <button type="button" 
                      data-action="click->step-form#previous"
                      class="flex-1 bg-gray-100 text-gray-700 py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-200 active:scale-[0.98] transition-all duration-200">
                이전
              </button>
              <button type="button" 
                      data-action="click->step-form#next"
                      class="flex-1 bg-gray-800 text-white py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-900 active:scale-[0.98] transition-all duration-200 shadow-lg shadow-gray-900/20">
                다음
              </button>
            </div>
          </div>
          
          <!-- 9단계: 최종 확인 -->
          <div data-step-form-target="step" class="step-content hidden">
            <div>
              <%= f.label :final_review, "입력 정보 확인", class: "block text-base font-semibold text-gray-900 mb-4" %>
              <div class="bg-gradient-to-br from-gray-50 to-indigo-50 rounded-2xl p-6 space-y-3 text-base shadow-inner">
                <div class="flex justify-between">
                  <span class="text-gray-700">이름</span>
                  <span class="font-semibold text-gray-900" id="review-name">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-700">연락처</span>
                  <span class="font-semibold text-gray-900" id="review-phone">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-700">이메일</span>
                  <span class="font-semibold text-gray-900" id="review-email">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-700">예약 일시</span>
                  <span class="font-semibold text-gray-900" id="review-datetime">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-700">코칭 형태</span>
                  <span class="font-semibold text-gray-900" id="review-coaching">-</span>
                </div>
                <div class="flex justify-between" id="review-subjects-container" style="display: none;">
                  <span class="text-gray-700">선택 과목</span>
                  <span class="font-semibold text-gray-900" id="review-subjects">-</span>
                </div>
                <div class="flex justify-between" id="review-requests-container" style="display: none;">
                  <span class="text-gray-700">요청사항</span>
                  <span class="font-semibold text-gray-900" id="review-requests">-</span>
                </div>
              </div>
            </div>
            <div class="mt-8 flex gap-3">
              <button type="button" 
                      data-action="click->step-form#previous"
                      class="flex-1 bg-gray-100 text-gray-700 py-4 px-6 rounded-2xl font-semibold text-base hover:bg-gray-200 active:scale-[0.98] transition-all duration-200">
                이전
              </button>
              <%= f.submit "예약하기",
                          class: "flex-1 bg-indigo-600 text-white py-4 px-6 rounded-2xl font-semibold shadow-lg shadow-indigo-600/20 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all transform active:scale-[0.98]" %>
            </div>
          </div>
        <% end %>
      <% end %>
        </div>
      </div>
      
      <!-- 하단 홈 인디케이터 -->
      <div class="bg-black h-6 flex items-center justify-center rounded-b-[2rem]">
        <div class="w-32 h-1 bg-white/30 rounded-full"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // 입력값 변경 시 실시간 업데이트 (Stimulus Controller의 updateReview와 함께 작동)
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reservation-form');
    if (form) {
      const triggerUpdate = () => {
        // Stimulus Controller가 연결되어 있으면 updateReview 호출
        const controllerElement = document.querySelector('[data-controller="step-form"]')
        if (controllerElement && window.Stimulus) {
          try {
            const controllerInstance = window.Stimulus.getControllerForElementAndIdentifier(controllerElement, 'step-form')
            if (controllerInstance && controllerInstance.updateReview) {
              // 현재 9단계에 있으면 업데이트
              if (controllerInstance.currentStepValue === 9) {
                controllerInstance.updateReview()
              }
            }
          } catch (e) {
            console.log("Controller not ready yet", e)
          }
        }
      };

      form.addEventListener('change', triggerUpdate);
      form.addEventListener('input', triggerUpdate);
    }
  });
</script>

